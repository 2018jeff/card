(function() {
  var $, Card;

  $ = jQuery;

  $.card = {};

  $.card.fn = {};

  $.fn.card = function(opts) {
    return $.card.fn.construct.apply(this, opts);
  };

  Card = (function() {
    var bind;

    Card.defaults = {
      selectors: {
        numberInput: 'input[name="number"]',
        expiryInput: 'input[name="expiry"]',
        cvcInput: 'input[name="cvc"]',
        numberDisplay: '.number-display',
        expiryDisplay: '.expiry-display',
        cvcDisplay: '.cvc-display'
      }
    };

    function Card(opts) {
      var _this = this;
      this.options = $.extend({}, opts, Card.defaults);
      $.each(this.options.selectors, function(name, selector) {
        return _this["$" + name] = _this.options[name] || $(selector);
      });
      this.attachFormatters();
      this.attachHandlers();
    }

    Card.prototype.attachFormatters = function() {
      this.$numberInput.payment('formatCardNumber');
      this.$expiryInput.payment('formatCardExpiry');
      return this.$cvcInput.payment('formatCardCVC');
    };

    Card.prototype.attachHandlers = function() {
      bind(this.$numberInput, this.$numberDisplay);
      bind(this.$expiryInput, this.$expiryDisplay);
      bind(this.$cvcInput, this.$cvcDisplay);
      return this.$cvcInput.on('focus', this.handle('cvcFocus'));
    };

    Card.prototype.handle = function(eventName) {
      var _this = this;
      return function(e) {
        var $el;
        $el = $(e.currentTarget);
        return _this.handlers[eventName].call(_this, e, $el);
      };
    };

    Card.prototype.handlers = {
      cvcFocus: function(e, $el) {
        return console.log("cvc focused");
      }
    };

    bind = function(inEl, outEl) {
      var outDefault;
      outDefault = outEl.text();
      return inEl.on('keyup', function(e) {
        var $el, val;
        $el = $(this);
        val = $el.val();
        return outEl.text(val + outDefault.substring(val.length));
      });
    };

    return Card;

  })();

  $.card.fn.construct = function(opts) {
    return new Card(opts);
  };

  $('form').card({});

}).call(this);
